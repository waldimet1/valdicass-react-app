// api/send-appointment-invite.js
// Simplified version without Firebase Admin

const sgMail = require('@sendgrid/mail');

module.exports = async (req, res) => {
  // Enable CORS
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader(
    'Access-Control-Allow-Headers',
    'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version'
  );

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // Set SendGrid API key from environment variable
  if (!process.env.SENDGRID_API_KEY) {
    console.error('‚ùå SENDGRID_API_KEY not found in environment variables');
    return res.status(500).json({ 
      ok: false,
      error: 'SendGrid API key not configured' 
    });
  }

  sgMail.setApiKey(process.env.SENDGRID_API_KEY);

  try {
    const {
      appointmentId,
      clientEmail,
      clientName,
      appointmentDate,
      appointmentType,
      address,
      notes,
      responseUrl,
      salesRepName,
    } = req.body;

    // Validate required fields
    if (!appointmentId || !clientEmail || !clientName || !appointmentDate || !responseUrl) {
      return res.status(400).json({ 
        error: 'Missing required fields: appointmentId, clientEmail, clientName, appointmentDate, responseUrl',
        ok: false 
      });
    }

    // Format the date
    const date = new Date(appointmentDate);
    const formattedDate = date.toLocaleDateString('en-US', {
      weekday: 'long',
      month: 'long',
      day: 'numeric',
      year: 'numeric',
    });
    const formattedTime = date.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
    });

    // Get appointment type label
    const getTypeLabel = (type) => {
      const labels = {
        'site-visit': 'Site Visit',
        'installation': 'Installation',
        'call': 'Call/Meeting',
      };
      return labels[type] || type;
    };

    // Create email HTML
    const emailHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.6; 
            color: #333; 
            margin: 0; 
            padding: 0;
            background-color: #f5f5f5;
          }
          .email-container { 
            max-width: 600px; 
            margin: 40px auto; 
            background: white; 
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          .email-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 40px 30px; 
            text-align: center;
          }
          .email-header h1 { 
            margin: 0; 
            font-size: 28px; 
            font-weight: 700;
          }
          .email-body { 
            padding: 40px 30px; 
          }
          .appointment-type {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 20px;
          }
          .appointment-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
          }
          .detail-row {
            display: flex;
            margin-bottom: 16px;
            align-items: flex-start;
          }
          .detail-row:last-child {
            margin-bottom: 0;
          }
          .detail-icon {
            font-size: 24px;
            margin-right: 12px;
            flex-shrink: 0;
          }
          .detail-content strong {
            display: block;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
          }
          .detail-content p {
            margin: 0;
            color: #666;
          }
          .action-buttons {
            text-align: center;
            margin: 32px 0;
          }
          .btn {
            display: inline-block;
            padding: 14px 32px;
            margin: 8px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            font-size: 15px;
          }
          .btn-confirm {
            background: #00a651;
            color: white !important;
          }
          .btn-view {
            background: #007bff;
            color: white !important;
          }
          .email-footer {
            background: #f8f9fa;
            padding: 24px 30px;
            text-align: center;
            color: #666;
            font-size: 13px;
          }
          .divider {
            border: 0;
            border-top: 2px solid #e0e0e0;
            margin: 24px 0;
          }
        </style>
      </head>
      <body>
        <div class="email-container">
          <div class="email-header">
            <h1>üìÖ Appointment Invitation</h1>
          </div>
          
          <div class="email-body">
            <p>Hi ${clientName},</p>
            
            <p>${salesRepName} from Valdicass has scheduled an appointment with you.</p>
            
            <div class="appointment-type">${getTypeLabel(appointmentType)}</div>
            
            <div class="appointment-details">
              <div class="detail-row">
                <span class="detail-icon">üìÖ</span>
                <div class="detail-content">
                  <strong>Date & Time</strong>
                  <p>${formattedDate}<br>${formattedTime}</p>
                </div>
              </div>
              
              ${address ? `
              <div class="detail-row">
                <span class="detail-icon">üìç</span>
                <div class="detail-content">
                  <strong>Location</strong>
                  <p>${address}</p>
                </div>
              </div>
              ` : ''}
              
              ${notes ? `
              <div class="detail-row">
                <span class="detail-icon">üìù</span>
                <div class="detail-content">
                  <strong>Notes</strong>
                  <p>${notes}</p>
                </div>
              </div>
              ` : ''}
              
              <div class="detail-row">
                <span class="detail-icon">üë§</span>
                <div class="detail-content">
                  <strong>Scheduled by</strong>
                  <p>${salesRepName}</p>
                </div>
              </div>
            </div>
            
            <hr class="divider">
            
            <p style="text-align: center; font-size: 16px; font-weight: 600; color: #333;">
              Please confirm your availability
            </p>
            
            <div class="action-buttons">
              <a href="${responseUrl}" class="btn btn-confirm">
                ‚úì Confirm Appointment
              </a>
              <br>
              <a href="${responseUrl}" class="btn btn-view">
                View Details & Respond
              </a>
            </div>
            
            <p style="font-size: 13px; color: #666; text-align: center;">
              Can't make it? Use the link above to decline or request a reschedule.
            </p>
          </div>
          
          <div class="email-footer">
            <p><strong>Valdicass</strong> - Window & Door Installation</p>
            <p>This is an automated appointment invitation.</p>
          </div>
        </div>
      </body>
      </html>
    `;

    // Create plain text version
    const emailText = `
Appointment Invitation

Hi ${clientName},

${salesRepName} from Valdicass has scheduled an appointment with you.

Type: ${getTypeLabel(appointmentType)}
Date: ${formattedDate}
Time: ${formattedTime}
${address ? `Location: ${address}` : ''}
${notes ? `Notes: ${notes}` : ''}

Please confirm your availability by visiting:
${responseUrl}

You can also use this link to decline or request a reschedule if needed.

---
Valdicass - Window & Door Installation
    `.trim();

    // Send email via SendGrid
    const msg = {
      to: clientEmail,
      from: {
        email: process.env.SENDGRID_FROM_EMAIL || 'no-reply@valdicass.com',
        name: 'Valdicass Appointments'
      },
      subject: `Appointment Invitation - ${formattedDate}`,
      text: emailText,
      html: emailHtml,
      trackingSettings: {
        clickTracking: { enable: true },
        openTracking: { enable: true },
      },
    };

    console.log('üì§ Sending appointment invite to:', clientEmail);
    const response = await sgMail.send(msg);
    
    console.log('‚úÖ Appointment invite sent successfully:', {
      to: clientEmail,
      appointmentId: appointmentId,
      messageId: response[0].headers['x-message-id'],
    });

    res.status(200).json({ 
      ok: true, 
      messageId: response[0].headers['x-message-id'],
      message: 'Appointment invitation sent successfully' 
    });

  } catch (error) {
    console.error('‚ùå Error sending appointment invite:', error);
    
    // Handle SendGrid errors specifically
    if (error.response) {
      console.error('SendGrid error details:', error.response.body);
      return res.status(error.code || 500).json({ 
        ok: false,
        error: error.response.body.errors?.[0]?.message || 'Failed to send email',
        details: error.response.body 
      });
    }
    
    res.status(500).json({ 
      ok: false,
      error: error.message || 'Internal server error' 
    });
  }
};